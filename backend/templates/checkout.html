{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - Pure Honey Shop{% endblock %}

{% block content %}
    <!-- Page Header -->
    <section class="page-header">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h1><i class="fas fa-credit-card"></i> Checkout</h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'index' %}">Home</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'cart' %}">Cart</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'checkout' %}">Checkout</a></li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
    </section>

    <!-- Checkout Progress -->
    <section class="checkout-progress">
        <div class="container">
            <div class="progress-steps">
                <div class="step active">
                    <div class="step-number">1</div>
                    <div class="step-title">Shipping</div>
                </div>
                <div class="step" id="payment-step">
                    <div class="step-number">2</div>
                    <div class="step-title">Payment</div>
                </div>
                <div class="step" id="review-step">
                    <div class="step-number">3</div>
                    <div class="step-title">Review</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Checkout Content -->
    <section class="checkout-section">
        <div class="container">
            <form method="POST" action="{% url 'create_order' %}">
                {% csrf_token %}
                <input type="hidden" name="cart_id" value="{{ cart.cart_id }}">
                <input type="hidden" name="total_amount" value="{{ cart.total }}">
                <div class="row">
                    <!-- Checkout Form -->
                    <div class="col-lg-8">
                        <!-- Step 1: Shipping Information -->
                        <div class="checkout-step" id="shipping-info">
                            <div class="step-header">
                                <h4><i class="fas fa-shipping-fast"></i> Shipping Information</h4>
                            </div>
                            
                            <!-- Saved Addresses -->
                            {% if user.is_authenticated and saved_addresses %}
                            <div class="saved-addresses">
                                <h6>Choose from saved addresses:</h6>
                                {% for address in saved_addresses %}
                                <div class="address-option">
                                    <input type="radio" name="saved_address" value="{{ address.id }}" 
                                           id="address-{{ address.id }}" {% if address.is_default %}checked{% endif %}
                                           onchange="selectSavedAddress({{ address.id }})">
                                    <label for="address-{{ address.id }}" class="address-card">
                                        <div class="address-header">
                                            <strong>{{ address.name }}</strong>
                                            {% if address.is_default %}
                                            <span class="badge bg-primary">Default</span>
                                            {% endif %}
                                        </div>
                                        <div class="address-details">
                                            {{ address.address }}
                                            {{ address.city }}, {{ address.state }} {{ address.postal_code }}<br>
                                            {{ address.country }}
                                            {% if address.phone %}<br><i class="fas fa-phone"></i> {{ address.phone }}{% endif %}
                                        </div>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <a href="{% url 'profile' %}#addresses" class="btn btn-honey">
                                <i class="fas fa-map-marker-alt"></i> Add Address
                            </a>
                        </div>
                        
                        <!-- Step 2: Payment Information -->
                        <div class="checkout-step" id="payment-info" style="display: none;">
                            <div class="step-header">
                                <h4><i class="fas fa-credit-card"></i> Payment Information</h4>
                            </div>
                            
                            <!-- Payment Methods -->
                            <div class="payment-methods">
                                <div class="payment-option">
                                    <input type="radio" name="payment_method" value="card" id="payment-card" checked>
                                    <label for="payment-card">
                                        <i class="fas fa-credit-card"></i> Credit/Debit Card
                                        <div class="payment-icons">
                                            <i class="fab fa-cc-visa"></i>
                                            <i class="fab fa-cc-mastercard"></i>
                                            <i class="fab fa-cc-amex"></i>
                                        </div>
                                    </label>
                                </div>
                                
                                <div class="payment-option">
                                    <input type="radio" name="payment_method" value="paypal" id="payment-paypal">
                                    <label for="payment-paypal">
                                        <i class="fab fa-paypal"></i> PayPal
                                    </label>
                                </div>
                                
                                <div class="payment-option">
                                    <input type="radio" name="payment_method" value="apple_pay" id="payment-apple">
                                    <label for="payment-apple">
                                        <i class="fab fa-apple-pay"></i> Apple Pay
                                    </label>
                                </div>
                                
                                <div class="payment-option">
                                    <input type="radio" name="payment_method" value="google_pay" id="payment-google">
                                    <label for="payment-google">
                                        <i class="fab fa-google-pay"></i> Google Pay
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Card Details Form -->
                            <div class="card-details" id="card-details">
                                <div class="mb-3">
                                    <label for="card_number" class="form-label">Card Number *</label>
                                    <div class="card-input-group">
                                        <input type="text" name="card_number" id="card_number" class="form-control" 
                                               placeholder="1234 5678 9012 3456" maxlength="19">
                                        <div class="card-type-icon" id="card-type-icon"></div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="card_expiry" class="form-label">Expiry Date *</label>
                                        <input type="text" name="card_expiry" id="card_expiry" class="form-control" 
                                               placeholder="MM/YY" maxlength="5">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="card_cvv" class="form-label">CVV *</label>
                                        <input type="text" name="card_cvv" id="card_cvv" class="form-control" 
                                               placeholder="123" maxlength="4">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="card_name" class="form-label">Name on Card *</label>
                                        <input type="text" name="card_name" id="card_name" class="form-control" 
                                               placeholder="John Doe">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 3: Order Review -->
                        <div class="checkout-step" id="order-review" style="display: none;">
                            <div class="step-header">
                                <h4><i class="fas fa-clipboard-check"></i> Review Your Order</h4>
                            </div>
                            
                            <!-- Order Items -->
                            <div class="order-items">
                                <h6>Order Items:</h6>
                                {% for item in cart_items %}
                                <div class="review-item">
                                    <div class="item-image">
                                        {% if item.product.image %}
                                            <img src="{{ item.product.image }}" alt="{{ item.product.name }}">
                                        {% else %}
                                            <img src="{% static 'images/honey-jar-placeholder.jpg' %}" alt="{{ item.product.name }}">
                                        {% endif %}
                                    </div>
                                    <div class="item-details">
                                        <h6>{{ item.product.name }}</h6>
                                        {% if item.variant %}
                                        <small class="text-muted">Size: {{ item.variant.size }}</small>
                                        {% endif %}
                                        <div class="item-quantity">Qty: {{ item.quantity }}</div>
                                    </div>
                                    <div class="item-price">${{ item.total_price|floatformat:2 }}</div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Shipping & Payment Summary -->
                            <div class="order-summary-review">
                                <div class="summary-section">
                                    <h6>Shipping Address:</h6>
                                    <div id="shipping-address-review"></div>
                                </div>
                                
                                <div class="summary-section">
                                    <h6>Payment Method:</h6>
                                    <div id="payment-method-review"></div>
                                </div>
                            </div>
                            
                            <!-- Terms and Conditions -->
                            <div class="terms-section">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="agree_terms" id="agree_terms" required>
                                    <label class="form-check-label" for="agree_terms">
                                        I agree to the <a href="#" target="_blank">Terms and Conditions</a> and 
                                        <a href="#" target="_blank">Privacy Policy</a>
                                    </label>
                                </div>
                                
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="subscribe_newsletter" id="subscribe_newsletter">
                                    <label class="form-check-label" for="subscribe_newsletter">
                                        Subscribe to our newsletter for updates and special offers
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Navigation Buttons -->
                        <div class="checkout-navigation">
                            <button type="button" class="btn btn-outline-secondary" id="prevBtn" style="display: none;">
                                <i class="fas fa-arrow-left"></i> Previous
                            </button>
                            <button type="button" class="btn btn-honey" id="nextBtn">
                                Next <i class="fas fa-arrow-right"></i>
                            </button>
                            <button type="submit" class="btn btn-honey btn-lg" id="submitBtn">
                                <i class="fas fa-lock"></i> Place Order
                            </button>

                        </div>
                    </div>
                    
                    <!-- Order Summary Sidebar -->
                    <div class="col-lg-4">
                        <div class="order-summary-sidebar sticky-top">
                            <h4>Order Summary</h4>
                            
                            <!-- Items List -->
                            <div class="summary-items">
                                {% for item in cart_items %}
                                <div class="summary-item">
                                    <div class="item-image">
                                        {% if item.product.image %}
                                            <img src="{{ item.product.image }}" alt="{{ item.product.name }}">
                                        {% else %}
                                            <img src="{% static 'images/honey-jar-placeholder.jpg' %}" alt="{{ item.product.name }}">
                                        {% endif %}
                                    </div>
                                    <div class="item-info">
                                        <h6>{{ item.product.name }}</h6>
                                        <div class="quantity">Qty: {{ item.quantity }}</div>
                                    </div>
                                    <div class="item-total">${{ item.total_price|floatformat:2 }}</div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Promo Code -->
                            <div class="promo-section">
                                <div class="input-group">
                                    <input type="text" name="promo_code" class="form-control" 
                                           placeholder="Promo code" value="{{ applied_coupon.code|default:'' }}">
                                    <button type="button" class="btn btn-outline-honey" onclick="applyPromoCode()">
                                        Apply
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Summary Lines -->
                            <div class="summary-calculations">
                                <div class="summary-line">
                                    <span>Subtotal:</span>
                                    <span>${{ cart.subtotal|floatformat:2 }}</span>
                                </div>
                                
                                <div class="summary-line">
                                    <span>Shipping:</span>
                                    <span id="shipping-cost">
                                        ${{ cart.shipping|floatformat:2 }}
                                    </span>
                                </div>
                                
                                <div class="summary-line">
                                    <span>Tax:</span>
                                    <span id="tax-amount">${{ cart.tax|floatformat:2 }}</span>
                                </div>
                                <div class="summary-line">
                                    <span><strong>Total:</strong></span>
                                    <span><strong id="final-total">${{ cart.total|floatformat:2 }}</strong></span>
                                </div>
                            </div>
                            
                            <!-- Security Info -->
                            <div class="security-info">
                                <div class="security-badge">
                                    <i class="fas fa-shield-alt"></i>
                                    <small>256-bit SSL encryption</small>
                                </div>
                                <div class="security-badge">
                                    <i class="fas fa-lock"></i>
                                    <small>Your data is secure</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section> 
{% endblock %}


{% block extra_js %}
<script>
    let currentStep = 1;
    const totalSteps = 3;
    
    // Initialize checkout form
    document.addEventListener('DOMContentLoaded', function() {
        updateStepVisibility();
        
        // Format card number input
        const cardNumberInput = document.getElementById('card_number');
        if (cardNumberInput) {
            cardNumberInput.addEventListener('input', formatCardNumber);
        }
        
        // Format expiry date input
        const cardExpiryInput = document.getElementById('card_expiry');
        if (cardExpiryInput) {
            cardExpiryInput.addEventListener('input', formatExpiryDate);
        }
        
        // CVV input restriction
        const cardCvvInput = document.getElementById('card_cvv');
        if (cardCvvInput) {
            cardCvvInput.addEventListener('input', function() {
                this.value = this.value.replace(/\D/g, '');
            });
        }
    });
    
    // Step navigation
    document.getElementById('nextBtn').addEventListener('click', function() {
        console.log("here")
        if (currentStep < totalSteps) {
            currentStep++;
            updateStepVisibility();
            updateProgressSteps();
            
            if (currentStep === 3) {
                updateOrderReview();
            }
        }
    });
    
    document.getElementById('prevBtn').addEventListener('click', function() {
        if (currentStep > 1) {
            currentStep--;
            updateStepVisibility();
            updateProgressSteps();
        }
    });
    
    function updateStepVisibility() {
        // Hide all steps
        document.querySelectorAll('.checkout-step').forEach(step => {
            step.style.display = 'none';
        });
        
        // Show current step
        const steps = ['shipping-info', 'payment-info', 'order-review'];
        document.getElementById(steps[currentStep - 1]).style.display = 'block';
        
        // Update navigation buttons
        document.getElementById('prevBtn').style.display = currentStep > 1 ? 'inline-block' : 'none';
        document.getElementById('nextBtn').style.display = currentStep < totalSteps ? 'inline-block' : 'none';
        document.getElementById('submitBtn').style.display = currentStep === totalSteps ? 'inline-block' : 'none';
    }
    
    function updateProgressSteps() {
        document.querySelectorAll('.progress-steps .step').forEach((step, index) => {
            step.classList.toggle('active', index < currentStep);
            step.classList.toggle('completed', index < currentStep - 1);
        });
    }
    
    function validateCurrentStep() {
        switch(currentStep) {
            case 1:
                return validateShippingInfo();
            case 2:
                return validatePaymentInfo();
            case 3:
                return validateOrderReview();
            default:
                return true;
        }
    }
    
    function validateShippingInfo() {
        const form = document.getElementById('address-form');
        if (form.style.display === 'none') {
            // Using saved address
            return document.querySelector('input[name="saved_address"]:checked') !== null;
        }
        
        // Validate new address form
        const requiredFields = ['first_name', 'last_name', 'email', 'phone', 'street_address', 'city', 'state', 'postal_code'];
        for (let field of requiredFields) {
            const input = document.getElementById(field);
            if (!input.value.trim()) {
                input.focus();
                showToast(`Please fill in ${field.replace('_', ' ')}`, 'error');
                return false;
            }
        }
        
        // Validate email format
        const email = document.getElementById('email').value;
        if (!isValidEmail(email)) {
            document.getElementById('email').focus();
            showToast('Please enter a valid email address', 'error');
            return false;
        }
        
        return true;
    }
    
    function validatePaymentInfo() {
        const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
        
        if (paymentMethod === 'card') {
            const requiredFields = ['card_number', 'card_expiry', 'card_cvv', 'card_name'];
            for (let field of requiredFields) {
                const input = document.getElementById(field);
                if (!input.value.trim()) {
                    input.focus();
                    showToast(`Please fill in ${field.replace('card_', '').replace('_', ' ')}`, 'error');
                    return false;
                }
            }
            
            // Validate card number
            if (!isValidCardNumber(document.getElementById('card_number').value)) {
                document.getElementById('card_number').focus();
                showToast('Please enter a valid card number', 'error');
                return false;
            }
            
            // Validate expiry date
            if (!isValidExpiryDate(document.getElementById('card_expiry').value)) {
                document.getElementById('card_expiry').focus();
                showToast('Please enter a valid expiry date', 'error');
                return false;
            }
        }
        
        return true;
    }
    
    function validateOrderReview() {
        if (!document.getElementById('agree_terms').checked) {
            showToast('Please agree to the terms and conditions', 'error');
            return false;
        }
        return true;
    }
    
    function updateOrderReview() {
        // Update shipping address review
        const shippingReview = document.getElementById('shipping-address-review');
        if (document.querySelector('input[name="saved_address"]:checked')) {
            const selectedAddress = document.querySelector('input[name="saved_address"]:checked');
            if (selectedAddress.value !== 'new') {
                const addressLabel = selectedAddress.nextElementSibling;
                shippingReview.innerHTML = addressLabel.innerHTML;
            } else {
                shippingReview.innerHTML = getNewAddressHTML();
            }
        } else {
            shippingReview.innerHTML = getNewAddressHTML();
        }
        
        // Update payment method review
        const paymentReview = document.getElementById('payment-method-review');
        const selectedPayment = document.querySelector('input[name="payment_method"]:checked');
        const paymentLabel = selectedPayment.nextElementSibling.textContent.trim();
        
        if (selectedPayment.value === 'card') {
            const cardNumber = document.getElementById('card_number').value;
            const maskedCard = '**** **** **** ' + cardNumber.slice(-4);
            paymentReview.innerHTML = `${paymentLabel}<br><small>${maskedCard}</small>`;
        } else {
            paymentReview.innerHTML = paymentLabel;
        }
    }
    
    function getNewAddressHTML() {
        const firstName = document.getElementById('first_name').value;
        const lastName = document.getElementById('last_name').value;
        const street = document.getElementById('street_address').value;
        const apartment = document.getElementById('apartment').value;
        const city = document.getElementById('city').value;
        const state = document.getElementById('state').value;
        const postalCode = document.getElementById('postal_code').value;
        const phone = document.getElementById('phone').value;
        
        return `
            <strong>${firstName} ${lastName}</strong><br>
            ${street}${apartment ? ', ' + apartment : ''}<br>
            ${city}, ${state} ${postalCode}<br>
            <i class="fas fa-phone"></i> ${phone}
        `;
    }
    
    function selectSavedAddress(addressId) {
        if (addressId) {
            document.getElementById('address-form').style.display = 'none';
        }
    }
    
    function toggleNewAddressForm() {
        const form = document.getElementById('address-form');
        form.style.display = 'block';
    }
    
    // Payment method change handler
    document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const cardDetails = document.getElementById('card-details');
            cardDetails.style.display = this.value === 'card' ? 'block' : 'none';
        });
    });
    
    // Card formatting functions
    function formatCardNumber(e) {
        let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || '';
        e.target.value = formattedValue.substr(0, 19);
        
        // Update card type icon
        updateCardTypeIcon(value);
    }
    
    function formatExpiryDate(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        e.target.value = value;
    }
    
    function updateCardTypeIcon(cardNumber) {
        const cardIcon = document.getElementById('card-type-icon');
        const firstDigit = cardNumber.charAt(0);
        const firstTwoDigits = cardNumber.substring(0, 2);
        
        if (firstDigit === '4') {
            cardIcon.innerHTML = '<i class="fab fa-cc-visa"></i>';
        } else if (['51', '52', '53', '54', '55'].includes(firstTwoDigits)) {
            cardIcon.innerHTML = '<i class="fab fa-cc-mastercard"></i>';
        } else if (['34', '37'].includes(firstTwoDigits)) {
            cardIcon.innerHTML = '<i class="fab fa-cc-amex"></i>';
        } else if (firstTwoDigits === '60') {
            cardIcon.innerHTML = '<i class="fab fa-cc-discover"></i>';
        } else {
            cardIcon.innerHTML = '';
        }
    }
    
    // Validation helper functions
    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email); 
        return true;
    }
    
    function isValidCardNumber(cardNumber) {
        const cleanNumber = cardNumber.replace(/\s+/g, '');
        return cleanNumber.length >= 13 && cleanNumber.length <= 19 && /^\d+$/.test(cleanNumber);
        return true;
    }
    
    function isValidExpiryDate(expiry) {
        const [month, year] = expiry.split('/');
        if (!month || !year) return false;
        
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear() % 100;
        const currentMonth = currentDate.getMonth() + 1;
        
        const expiryMonth = parseInt(month);
        const expiryYear = parseInt(year);
        
        if (expiryMonth < 1 || expiryMonth > 12) return false;
        if (expiryYear < currentYear || (expiryYear === currentYear && expiryMonth < currentMonth)) return false;
        
        return true;
    }
    
</script>
{% endblock %}